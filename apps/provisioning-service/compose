# SPDX-License-Identifier: AGPL-3.0-only
# SPDX-FileCopyrightText: 2024 Univention GmbH


services:

  nats:
    image: docker.software-univention.de/nats:latest
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # Monitoring endpoint (optional)
    secrets:
      - nats-conf
    command: -c /run/secrets/nats-conf
    networks:
      - "nubus-provisioning"
    volumes:
      - /var/lib/univention-appcenter/apps/provisioning-service/data/nats-data/:/data

  provisioning-api:
    image: "gitregistry.knut.univention.de/univention/dev/projects/provisioning/provisioning-api:idelgado-remove-backup-consumer"
    container_name: "nubus-provisioning-api"
    restart: "on-failure"
    environment:
      -  LOG_LEVEL=DEBUG
      -  NATS_HOST=nats
      -  NATS_PORT=4222
      -  NATS_USER=api
      -  NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
      -  ADMIN_NATS_USER=NOT_SET_NOT_REQUIRED
      -  ADMIN_NATS_PASSWORD=NOT_SET_NOT_REQUIRED
      -  ADMIN_USERNAME=admin
      -  ADMIN_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["PROVISIONING_API_ADMIN_PASSWORD"]);@!@
      -  PREFILL_USERNAME=prefill
      -  PREFILL_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
      -  MAX_PREFILL_ATTEMPTS=5
      -  EVENTS_USERNAME_UDM=udm
      -  EVENTS_PASSWORD_UDM=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["EVENTS_PASSWORD_UDM"]);@!@
      -  DEBUG=false
      -  ROOT_PATH=/univention/provisioning
      -  CORS_ALL=false
    volumes:
      - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
    networks:
      - "nubus-provisioning"
    depends_on:
      - "nats"

  dispatcher:
    image: "gitregistry.knut.univention.de/univention/dev/projects/provisioning/provisioning-dispatcher:idelgado-remove-backup-consumer"
    container_name: "nubus-provisioning-dispatcher"
    restart: "on-failure"
    environment:
      -  LOG_LEVEL=DEBUG
      @!@print("-  NATS_HOST_PULL=nats" if configRegistry.get('server/role').lower() == "domaincontroller_master" else f"-  NATS_HOST_PULL={configRegistry.get('ldap/master')}")@!@
      -  NATS_HOST_PUSH=nats
      -  NATS_PORT_PULL=4222
      -  NATS_PORT_PUSH=4222
      -  NATS_USER_PULL=dispatcher
      -  NATS_USER_PUSH=dispatcher
      -  NATS_PASSWORD_PULL=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
      -  NATS_PASSWORD_PUSH=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
      -  NATS_MAX_RECONNECT_ATTEMPTS=2
      -  PROVISIONING_API_HOST=provisioning-api
      -  PROVISIONING_API_PORT=7777
    depends_on:
      - "nats"
      - "provisioning-api"
    networks:
      - "nubus-provisioning"
    #entrypoint: ["sleep", "10000"]

  udm-transformer:
    image: "gitregistry.knut.univention.de/univention/dev/projects/provisioning/provisioning-udm-transformer:idelgado-remove-backup-consumer"
    container_name: "nubus-provisioning-udm-transformer"
    restart: "on-failure"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
        - LOG_LEVEL=DEBUG
        - NATS_HOST=nats
        - NATS_PORT=4222
        - NATS_USER=udm-transformer
        - NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
        - LDAP_PUBLISHER_NAME=udm-listener
        - PROVISIONING_API_HOST=provisioning-api
        - PROVISIONING_API_PORT=7777
        - EVENTS_USERNAME_UDM=udm
        - EVENTS_PASSWORD_UDM=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["EVENTS_PASSWORD_UDM"]);@!@
        - LDAP_HOST=@%@ldap/server/name@%@
        - LDAP_PORT=@%@ldap/server/port@%@
        - LDAP_TLS_MODE=off
        - LDAP_BASE_DN=@%@ldap/base@%@
        - LDAP_BIND_DN=cn=admin,@%@ldap/base@%@
        - LDAP_BIND_PW=@!@print(open("/etc/ldap.secret").read())@!@
    depends_on:
      - "nats"
    networks:
      - "nubus-provisioning"
    volumes:
      - /usr/lib/python3/dist-packages/univention/udm/modules/:/usr/lib/python3/dist-packages/univention/udm/modules/
      - /usr/lib/python3/dist-packages/univention/:/usr/lib/python3/dist-packages/univention/

  prefill:
    image: "gitregistry.knut.univention.de/univention/dev/projects/provisioning/provisioning-prefill:idelgado-remove-backup-consumer"
    container_name: "nubus-provisioning-prefill"
    restart: "on-failure"
    environment:
     - LOG_LEVEL=DEBUG
     - NATS_HOST=nats
     - NATS_PORT=4222
     - PROVISIONING_API_HOST=provisioning-api
     - PROVISIONING_API_PORT=7777
     - NATS_USER=prefill
     - NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
     - NATS_MAX_RECONNECT_ATTEMPTS=2
     - UDM_HOST=@%@ldap/server/name@%@
     - UDM_PORT=443
     - UDM_URL_PREFIX=/univention
     - UDM_PROTOCOL=https
     - UDM_USERNAME=cn=admin
     - UDM_PASSWORD=@!@print(open("/etc/ldap.secret").read())@!@
     - PREFILL_USERNAME=prefill
     - PREFILL_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
     - MAX_PREFILL_ATTEMPTS=5
     - NETWORK_RETRY_STARTING_INTERVAL=1
     - NETWORK_RETRY_MAX_DELAY=120
     - NETWORK_RETRY_MAX_ATTEMPTS=60
    volumes:
      - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
    depends_on:
      - "provisioning-api"
    networks:
      - "nubus-provisioning"


networks:
  nubus-provisioning:
    driver: bridge
    name: "nubus-provisioning"

secrets:
  nats-conf:
    file: /var/lib/univention-appcenter/apps/provisioning-service/conf/nats.conf
