# SPDX-License-Identifier: AGPL-3.0-only
# SPDX-FileCopyrightText: 2024 Univention GmbH


services:

  nats:
    image: nats:latest
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # Monitoring endpoint (optional)
    secrets:
      - nats-conf
    command: -c /run/secrets/nats-conf
    networks:
      - "nubus-provisioning"
    volumes:
      - /var/lib/univention-appcenter/apps/provisioning-service/data/nats-data/:/data

  provisioning-api:
    image: "gitregistry.knut.univention.de/univention/dev/projects/provisioning/provisioning-api:feat-provisioning-stack-listener-cleanup"
    container_name: "nubus-provisioning-api"
    restart: "on-failure"
    environment:
      -  LOG_LEVEL=DEBUG
      -  NATS_HOST=nats
      -  NATS_PORT=4222
      -  NATS_USER=api
      -  NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
      -  ADMIN_NATS_USER=NOT_SET_NOT_REQUIRED
      -  ADMIN_NATS_PASSWORD=NOT_SET_NOT_REQUIRED
      -  ADMIN_USERNAME=admin
      -  ADMIN_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["PROVISIONING_API_ADMIN_PASSWORD"]);@!@
      -  PREFILL_USERNAME=prefill
      -  PREFILL_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
      -  MAX_PREFILL_ATTEMPTS=5
      -  EVENTS_USERNAME_UDM=udm
      -  EVENTS_PASSWORD_UDM=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["EVENTS_PASSWORD_UDM"]);@!@
      -  DEBUG=false
      -  ROOT_PATH=/univention/provisioning
      -  CORS_ALL=false
    volumes:
      - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
    networks:
      - "nubus-provisioning"
    depends_on:
      - "nats"

  dispatcher:
    image: "gitregistry.knut.univention.de/univention/dev/projects/provisioning/provisioning-dispatcher:feat-provisioning-stack-listener-cleanup"
    container_name: "nubus-provisioning-dispatcher"
    restart: "on-failure"
    environment:
      -  LOG_LEVEL=DEBUG
      -  NATS_HOST=nats
      -  NATS_PORT=4222
      -  NATS_USER=dispatcher
      -  NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
      -  NATS_MAX_RECONNECT_ATTEMPTS=2
      -  PROVISIONING_API_HOST=provisioning-api
      -  PROVISIONING_API_PORT=7777
    depends_on:
      - "nats"
      - "provisioning-api"
    networks:
      - "nubus-provisioning"
    #entrypoint: ["sleep", "10000"]

  udm-transformer:
    image: "gitregistry.knut.univention.de/univention/dev/projects/provisioning/provisioning-udm-transformer:feat-provisioning-stack-listener-cleanup"
    container_name: "nubus-provisioning-udm-transformer"
    restart: "on-failure"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
        - LOG_LEVEL=DEBUG
        - NATS_HOST=nats
        - NATS_PORT=4222
        - NATS_USER=udm-transformer
        - NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
        - LDAP_PUBLISHER_NAME=udm-listener
        - PROVISIONING_API_HOST=provisioning-api
        - PROVISIONING_API_PORT=7777
        - EVENTS_USERNAME_UDM=udm
        - EVENTS_PASSWORD_UDM=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["EVENTS_PASSWORD_UDM"]);@!@
        - LDAP_HOST=@%@ldap/server/name@%@
        - LDAP_PORT=@%@ldap/server/port@%@
        - LDAP_TLS_MODE=off
        - LDAP_BASE_DN=@%@ldap/base@%@
        - LDAP_BIND_DN=cn=admin,@%@ldap/base@%@
        - LDAP_BIND_PW=@!@print(open("/etc/ldap.secret").read())@!@
    depends_on:
      - "nats"
    networks:
      - "nubus-provisioning"
    volumes:
      - /usr/lib/python3/dist-packages/univention/udm/modules/:/usr/lib/python3/dist-packages/univention/udm/modules/
      - /usr/lib/python3/dist-packages/univention/:/usr/lib/python3/dist-packages/univention/

  prefill:
    image: "gitregistry.knut.univention.de/univention/dev/projects/provisioning/provisioning-prefill:feat-provisioning-stack-listener-cleanup"
    container_name: "nubus-provisioning-prefill"
    restart: "on-failure"
    environment:
     - LOG_LEVEL=DEBUG
     - NATS_HOST=nats
     - NATS_PORT=4222
     - PROVISIONING_API_HOST=provisioning-api
     - PROVISIONING_API_PORT=7777
     - NATS_USER=prefill
     - NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
     - NATS_MAX_RECONNECT_ATTEMPTS=2
     - UDM_HOST=@%@ldap/server/name@%@
     - UDM_PORT=443
     - UDM_URL_PREFIX=/univention
     - UDM_PROTOCOL=https
     - UDM_USERNAME=cn=admin
     - UDM_PASSWORD=@!@print(open("/etc/ldap.secret").read())@!@
     - PREFILL_USERNAME=prefill
     - PREFILL_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
     - MAX_PREFILL_ATTEMPTS=5
    volumes:
      - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
    depends_on:
      - "provisioning-api"
    networks:
      - "nubus-provisioning"
  backup-consumer:
    image: "gitregistry.knut.univention.de/univention/dev/projects/provisioning/backup-consumer:feat-provisioning-stack-listener-cleanup"
    restart: "on-failure"
    container_name: "nubus-primary2backup-consumer"
    command: >
      backup_consumer
      --provisioning-api-admin-user admin
      --provisioning-api-admin-user-password @!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["PROVISIONING_API_ADMIN_PASSWORD"]);@!@
      --nats-user "api"
      --nats-password @!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
      --target-nats "nats://nats:4222"
      --provisioning-url https://@%@ldap/master@%@/univention/provisioning/
      --stream-name "primary2backup-@%@hostname@%@"
    environment:
      @!@print(f"- HOST_SERVER_ROLE={configRegistry.get('server/role').lower()}")@!@
      - PROVISIONING_API_USERNAME=admin
      - PROVISIONING_API_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-secrets.json"))["NATS_PASSWORD"]);@!@
      - LOG_LEVEL=DEBUG
      - PROVISIONING_API_BASE_URL="http://provisioning-api:7777"
      - MAX_ACKNOWLEDGEMENT_RETRIES=5
    volumes:
      - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
    networks:
      - nubus-provisioning

networks:
  nubus-provisioning:
    driver: bridge
    name: "nubus-provisioning"

secrets:
  nats-conf:
    file: /var/lib/univention-appcenter/apps/provisioning-service/conf/nats.conf
