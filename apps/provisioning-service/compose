# SPDX-License-Identifier: AGPL-3.0-only
# SPDX-FileCopyrightText: 2024 Univention GmbH


services:

  nats:
    image: nats:latest
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # Monitoring endpoint (optional)
    secrets:
      - nats-conf
    command: -c /run/secrets/nats-conf
    networks:
      - "nubus-provisioning"
    volumes:
      - /var/lib/univention-appcenter/apps/provisioning-service/data/nats-data/:/data

  provisioning-api:
    image: "artifacts.software-univention.de/nubus/images/provisioning-events-and-consumer-api:0.56.0"
    container_name: "nubus-provisioning-api"
    restart: "on-failure"
    environment:
      -  LOG_LEVEL=DEBUG
      -  NATS_HOST=nats
      -  NATS_PORT=4222
      -  NATS_USER=api
      -  NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["NATS_PASSWORD"]);@!@
      -  ADMIN_NATS_USER=admin
      -  ADMIN_NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["ADMIN_NATS_PASSWORD"]);@!@
      -  ADMIN_USERNAME=admin
      -  ADMIN_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["ADMIN_NATS_PASSWORD"]);@!@
      -  PREFILL_USERNAME=prefill
      -  PREFILL_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["PREFILL_PASSWORD"]);@!@
      -  MAX_PREFILL_ATTEMPTS=5
      -  EVENTS_USERNAME_UDM=udm
      -  EVENTS_PASSWORD_UDM=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["EVENTS_PASSWORD_UDM"]);@!@
      -  DEBUG=false
      -  ROOT_PATH=/
      -  CORS_ALL=false
    networks:
      - "nubus-provisioning"
    depends_on:
      - "nats"
    ports:
      - "7778:7777"

  dispatcher:
    image: "artifacts.software-univention.de/nubus/images/provisioning-dispatcher:0.56.0"
    container_name: "nubus-provisioning-dispatcher"
    restart: "on-failure"
    environment:
      -  LOG_LEVEL=DEBUG
      -  NATS_HOST=nats
      -  NATS_PORT=4222
      -  NATS_USER=dispatcher
      -  NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["NATS_PASSWORD"]);@!@
      -  NATS_MAX_RECONNECT_ATTEMPTS=2
      -  PROVISIONING_API_HOST=provisioning-api
      -  PROVISIONING_API_PORT=7777
    depends_on:
      - "nats"
      - "provisioning-api"
    networks:
      - "nubus-provisioning"
    #entrypoint: ["sleep", "10000"]

  udm-transformer:
    image: "artifacts.software-univention.de/nubus/images/provisioning-udm-transformer:0.56.0"
    container_name: "nubus-provisioning-udm-transformer"
    restart: "on-failure"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
        - LOG_LEVEL=DEBUG
        - NATS_HOST=nats
        - NATS_PORT=4222
        - NATS_USER=udm-transformer
        - NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["NATS_PASSWORD"]);@!@
        - LDAP_PUBLISHER_NAME=udm-listener
        - PROVISIONING_API_HOST=provisioning-api
        - PROVISIONING_API_PORT=7777
        - EVENTS_USERNAME_UDM=udm
        - EVENTS_PASSWORD_UDM=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["EVENTS_PASSWORD_UDM"]);@!@
        - LDAP_HOST=@%@ldap/server/name@%@
        - LDAP_PORT=@%@ldap/server/port@%@
        - LDAP_TLS_MODE=off
        - LDAP_BASE_DN=@%@ldap/base@%@
        - LDAP_BIND_DN=cn=admin,@%@ldap/base@%@
        - LDAP_BIND_PW=@!@print(open("/etc/ldap.secret").read())@!@
    depends_on:
      - "nats"
    networks:
      - "nubus-provisioning"
    entrypoint: "/app/.venv/bin/python3"
    command: |
      -c '
      import os
      import time
      from univention.admin.uldap import access
      from univention.udm import UDM
      from univention.udm.helpers import get_all_udm_module_names
      lo = access(host=os.environ["LDAP_HOST"], port=os.environ["LDAP_PORT"], base=os.environ["LDAP_BASE_DN"], binddn=os.environ["LDAP_BIND_DN"], bindpw=os.environ["LDAP_BIND_PW"], start_tls=0)
      user_mod = UDM(lo, 0).get("users/user")
      group_mod = UDM(lo, 0).get("groups/group")
      print("UDM modules:", get_all_udm_module_names())
      print("UDM users/user properties:", sorted(user_mod.meta.mapping.ldap2udm.values()))
      print("UDM groups/group properties:", sorted(group_mod.meta.mapping.ldap2udm.values()))
      print("Starting UDM Transformer...")
      with open("/app/src/udm_transformer/main.py") as fp:
        exec(fp.read())'
    volumes:
      - /usr/lib/python3/dist-packages/univention/udm/modules/:/usr/lib/python3/dist-packages/univention/udm/modules/
      - /usr/lib/python3/dist-packages/univention/admin/:/usr/lib/python3/dist-packages/univention/admin/

  prefill:
    image: "artifacts.software-univention.de/nubus/images/provisioning-prefill:0.56.0"
    container_name: "nubus-provisioning-prefill"
    restart: "on-failure"
    environment:
     - LOG_LEVEL=DEBUG
     - NATS_HOST=nats
     - NATS_PORT=4222
     - PROVISIONING_API_HOST=provisioning-api
     - PROVISIONING_API_PORT=7777
     - NATS_USER=prefill
     - NATS_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["PREFILL_PASSWORD"]);@!@
     - NATS_MAX_RECONNECT_ATTEMPTS=2
     - UDM_HOST=udm-proxy
     - UDM_PORT=80
     - UDM_USERNAME=cn=admin
     - UDM_PASSWORD=@!@print(open("/etc/ldap.secret").read())@!@
     - PREFILL_USERNAME=prefill
     - PREFILL_PASSWORD=@!@import json; print(json.load(open("/etc/provisioning-json.secrets"))["PREFILL_PASSWORD"]);@!@
     - MAX_PREFILL_ATTEMPTS=5
    depends_on:
      - "provisioning-api"
    networks:
      - "nubus-provisioning"

  udm-proxy:
    image: nginx:alpine
    container_name: udm-proxy
    command: >
      /bin/sh -c "echo '
        events {}
        http {
          server {
            listen 80;
            location /udm {
              proxy_pass http://@%@ldap/server/name@%@/univention/udm;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
            }
            location /univention/udm {
              proxy_pass http://@%@ldap/server/name@%@/univention/udm;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
            }
          }
        }' > /etc/nginx/nginx.conf && cat /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
    networks:
    - "nubus-provisioning"

networks:
  nubus-provisioning:
    driver: bridge
    name: "nubus-provisioning"

secrets:
  nats-conf:
    file: /var/lib/univention-appcenter/apps/provisioning-service/conf/nats.conf
